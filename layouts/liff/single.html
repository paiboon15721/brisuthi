{{ define "content" }}
<div class="container rewards" id="app">
  <div class="page-header">
    <h1 class="title">${title}</h1>
    <h2 class="subtitle" v-show="message">${message}</h2>
  </div>
  <div class="content">
    <div class="loading" v-show="loading">
      <p>Loading...</p>
    </div>
    <div class="success" v-if="tier">
      <div class="center">
        <p>Tier: ${tier.tier}</p>
        <p>Online discount: ${tier.onlineDiscount}%</p>
        <p>Birthday discount: ${tier.birthdayDiscount}%</p>
      </div>
    </div>
    <div class="register" v-if="status === 'Unauthorized'">
      <form
        id="registerForm"
        ref="registerForm"
        @submit.prevent="submit"
        class="form"
      >
        <div class="form-control">
          <label for="email">email</label>
          <input
            type="email"
            v-model="email"
            id="email"
            name="email"
            required
          />
        </div>
        <button :disabled="loading" type="submit">Register</button>
      </form>
    </div>
  </div>
</div>
{{ end }}
{{ define "javascript" }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.10/vue.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js"></script>
<script src="https://d.line-scdn.net/liff/1.0/sdk.js"></script>
<script>
  var baseUrl = 'http://localhost:4000'
  liff.init = f =>
    f({ context: { userId: 'U5905181fde8e199deef987cbc54b438b' } })
  liff.init(function(line) {
    var app = new Vue({
      el: '#app',
      delimiters: ['${', '}'],
      data: {
        tier: null,
        status: null,
        title: 'rewards',
        email: '',
        message: null,
        loading: false,
      },
      methods: {
        submit: function() {
          this.loading = true
          axios
            .post(`${baseUrl}/api/registers`, {
              email: this.email,
              userId: line.context.userId,
            })
            .then(res => {
              this.status = 'waitForApprove'
              this.title = 'waiting for approval.'
              this.loading = false
            })
            .catch(e => {
              var message = e.response.data.message
              if (message === 'emailNotFound') {
                this.message = 'Email not found, please contact admin.'
              } else if (message === 'emailDuplicate') {
                this.message = 'This email aready registered.'
              } else {
                this.message = this.status
              }
              this.loading = false
            })
        },
      },
      mounted() {
        this.loading = true
        axios
          .get(`${baseUrl}/api/rewards?userId=${line.context.userId}`)
          .then(res => {
            this.tier = res.data.data
            this.loading = false
          })
          .catch(e => {
            this.status = e.response.data.message
            if (this.status === 'Unauthorized') {
              this.title = 'Please register your email.'
            } else {
              this.title = 'waiting for approval.'
            }
            this.loading = false
          })
      },
    })
  })
</script>
{{ end }}
